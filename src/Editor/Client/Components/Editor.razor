
@using Medulla.Editor.Client.AppRenderer;
@using Medulla.Editor.Client.AppRenderer.Options;
@using Medulla.Editor.Client.AppRenderer.RendererComponents;



<div style="display: grid; grid-template-columns: 70% auto;">
    <div>
        <Renderer AppNodeList=appNodeList />
    </div>

    <div class="Box" style="height: 100vh">

        @if (tmpChildAppNodeList != null)
        {

            <nav aria-label="Breadcrumb" class="p-4">
                <ol>
                    <li  class="breadcrumb-item">
                        <a style="cursor: pointer;" @onclick=@(() => { tmpChildAppNodeList = null; ChildList.Clear(); })>root</a>
                    </li>
                    @foreach (var child in ChildList)
                    {
                        <li class="breadcrumb-item">
                            <a @onclick=@(() => tmpChildAppNodeList = child?.Children)>@child.Component</a>
                        </li>
                    }
                </ol>
            </nav>
        }

        <nav class="menu" aria-label="Person settings">
            @foreach (var appNode in GetAppNodeList())
            {
                <span data-node-id="@appNode.Id" class="menu-item" aria-current="page">
                    @appNode.Component
                    <MenuItemButton OnClick=@(() => nodeMinus(appNode))>
                        <Minus/>
                    </MenuItemButton>
                    <MenuItemButton OnClick=@(() => nodeCopy(appNode))>
                        <Copy/>
                    </MenuItemButton>
                    <MenuItemButton OnClick="@nodeSettings">
                        <Settings/>
                    </MenuItemButton>
                    <MenuItemButton OnClick=@(() => nodeUpArrow(appNode))>
                        <UpArrow/>
                    </MenuItemButton>
                    <MenuItemButton OnClick=@(() => nodeDownArrow(appNode))>
                        <DownArrow/>
                    </MenuItemButton>


                    <span style="cursor: pointer;" @onclick=@(() => nodeChildren(appNode)) class="Label">
                        <div style="
                            position: relative;
                            top: 1px;">
                            <span style="font-weight: bold;font-size: 15px;padding: 4px;">
                                @appNode?.Children.Count
                            </span>
                        </div>
                    </span>
                </span>
            }


            @if (isAddingNewComponent)
            {
                <div class="Box p-4">
                    <p>Adding a new component</p>

                    <details class="details-reset details-overlay" @attributes="@GetNewComponentOpen()">
                        <summary style="pointer-events: none" class="btn" aria-haspopup="true">
                            @if (newComponent == null)
                            {
                                <span>Choose a component</span>
                            }
                            else
                            {
                                <span>@newComponent</span>
                            }
                        </summary>
                        <div class="SelectMenu" style="display: block; position: static;">
                            <div class="SelectMenu-modal">
                                <div class="SelectMenu-list">
                                    <button @onclick=@(() => SetNewComponentOpen("Box")) class="SelectMenu-item" role="menuitem">Box</button>
                                    <button @onclick=@(() => SetNewComponentOpen("Button")) class="SelectMenu-item" role="menuitem">Button</button>
                                    <button @onclick=@(() => SetNewComponentOpen("Input")) class="SelectMenu-item" role="menuitem">Input</button>
                                </div>
                            </div>
                        </div>
                    </details>

                    @*<div class="flex mt-5">
                        <span @onclick="@newcomponent" style="cursor:pointer;" class="btn" type="button">
                            Cancel
                        </span>
                        @if (newComponent != null)
                        {
                            <button @onclick=@(() => AddComponent(newComponent)) class="btn" type="button">Add</button>
                        }
                        else
                        {
                            <button class="btn" type="button">Add</button>
                        }

                    </div>*@

                </div>
            }
            else
            {
                <span style="cursor:pointer;" @onclick="@newcomponent" class="menu-item" href="#url">
                    New Component
                </span>
            }
        </nav>

    </div>
</div>

@code {

    private List<AppNode> ChildList = new List<AppNode>();

    private void AddComponent(string component)
    {
        if (tmpChildAppNodeList != null)
        {
            tmpChildAppNodeList.Add(new AppNode
            {
                Component = component
            });

        }
        else
        {
            appNodeList.Add(new AppNode
            {
                Component = component
            });
        }
        isNewComponentOpen = false;
        isAddingNewComponent = false;
    }

    private bool isAddingNewComponent = false;
    private bool isNewComponentOpen = true;
    private string? newComponent = null;

    private Dictionary<string, object> GetNewComponentOpen()
    {
        var options = new Dictionary<string, object>()
        {
            { "open", isNewComponentOpen },
        };

        return options;
    }

    private void SetNewComponentOpen(string component)
    {
        isNewComponentOpen = false;
        newComponent = component;
        AddComponent(component);
        StateHasChanged();
    }

    private List<AppNode>? tmpChildAppNodeList = null;

    private List<AppNode> GetAppNodeList()
    {
        var nodeList = new List<AppNode>();

        if (tmpChildAppNodeList != null)
        {
            nodeList = tmpChildAppNodeList;
        }
        else
        {
            nodeList = appNodeList;
        }

        return nodeList;
    }

    private void nodeMinus(AppNode node)
    {
        Console.WriteLine("nodeMinus");
        if (tmpChildAppNodeList != null)
        {
            tmpChildAppNodeList.Remove(node);
        }
        else
        {
            appNodeList.Remove(node);
        }
        StateHasChanged();
    }

    private void nodePlus()
    {
        Console.WriteLine("clicked plus button");
    }

    private void nodeCopy(AppNode node)
    {
        var nodeToAdd = (AppNode)node.Clone();

        if (tmpChildAppNodeList != null)
        {
            tmpChildAppNodeList.Insert(tmpChildAppNodeList.FindIndex(x => x.Id == node.Id) + 1, nodeToAdd);
        }
        else
        {
            appNodeList.Insert(appNodeList.FindIndex(x => x.Id == node.Id) + 1, nodeToAdd);
        }

        StateHasChanged();
    }

    private void nodeSettings()
    {
        Console.WriteLine("clicked settings button");
    }

    private void nodeUpArrow(AppNode node)
    {
        if (tmpChildAppNodeList != null)
        {
            var index = tmpChildAppNodeList.FindIndex(x => x.Id == node.Id);
            if (index > 0)
            {
                var nodeToMove = tmpChildAppNodeList[index];
                tmpChildAppNodeList.RemoveAt(index);
                tmpChildAppNodeList.Insert(index - 1, nodeToMove);
            }
        }
        else
        {
            var index = appNodeList.FindIndex(x => x.Id == node.Id);
            if (index > 0)
            {
                var nodeToMove = appNodeList[index];
                appNodeList.RemoveAt(index);
                appNodeList.Insert(index - 1, nodeToMove);
            }
        }
        StateHasChanged();
    }

    private void nodeDownArrow(AppNode node)
    {
        if (tmpChildAppNodeList != null)
        {
            var index = tmpChildAppNodeList.FindIndex(x => x.Id == node.Id);
            if (index < tmpChildAppNodeList.Count - 1)
            {
                var nodeToMove = tmpChildAppNodeList[index];
                tmpChildAppNodeList.RemoveAt(index);
                tmpChildAppNodeList.Insert(index + 1, nodeToMove);
            }
        }
        else
        {
            var index = appNodeList.FindIndex(x => x.Id == node.Id);
            if (index < appNodeList.Count - 1)
            {
                var nodeToMove = appNodeList[index];
                appNodeList.RemoveAt(index);
                appNodeList.Insert(index + 1, nodeToMove);
            }
        }
        StateHasChanged();
    }

    private void nodeChildren(AppNode node)
    {
        tmpChildAppNodeList = node.Children;
        ChildList.Add(node);
        StateHasChanged();
    }

    private void newcomponent()
    {
        isAddingNewComponent = !isAddingNewComponent;
        isNewComponentOpen = true;
        newComponent = null;
        StateHasChanged();
        Console.WriteLine("clicked new component button");
    }

    private List<AppNode> appNodeList = new List<AppNode>() {
        /*new AppNode() {
            Component = "Button",
            Options = new () {
                Options = new () {
                    new () {
                        Key = new Key() {
                            KeyName = "Content"
                        },
                        Value = new Value() {
                            ValueOfKey = "Create Something Awesome!"
                        }
                    }
                }
            }
        },
        new AppNode() {
            Component = "Button",
            Options = new () {
                Options = new () {
                    new () {
                        Key = new Key() {
                            KeyName = "Content"
                        },
                        Value = new Value() {
                            ValueOfKey = "Create Something Awesome!"
                        }
                    }
                }
            }
        },
        new AppNode() {
            Component = "Box",
            Options = new () {
                Options = new () {
                    new () {
                        Key = new Key() {
                            KeyName = "Content"
                        },
                        Value = new Value() {
                            ValueOfKey = "Create Something Awesome!"
                        }
                    }
                }
            },
            Children = new() {
                new AppNode() {
                Component = "Button",
                Options = new () {
                    Options = new () {
                        new () {
                            Key = new Key() {
                                KeyName = "Content"
                            },
                            Value = new Value() {
                                ValueOfKey = "Create Something Awesome!"
                            }
                        }
                    }
                }
            },
            }
        },*/
    };


}


